<!doctype html>
<html>
<body>
<input type=button value="Clear" id=clear-button>
<script type=module>
import localforage from './localforage.js';

let memoryStorage = {};
localforage.getItem = (getItem => function(key) {
  try {
    return getItem.apply(this, arguments);
  } catch(err) {
    console.warn(err);
    let result =  memoryStorage[key];
    if (result === undefined) {
      result = null;
    }
    return Promise.resolve(result);
  }
})(localforage.getItem);
localforage.setItem = (setItem => function(key, value) {
  try {
    return setItem.apply(this, arguments);
  } catch(err) {
    console.warn(err);
    memoryStorage[key] = value;
    return Promise.resolve();
  }
})(localforage.setItem);
localforage.removeItem = (removeItem => function(key) {
  try {
    return removeItem.apply(this, arguments);
  } catch(err) {
    console.warn(err);
    delete memoryStorage[key];
    return Promise.resolve();
  }
})(localforage.removeItem);
localforage.clear = (clear => function() {
  try {
    return clear.apply(this, arguments);
  } catch(err) {
    console.warn(err);
    memoryStorage = {};
    return Promise.resolve();
  }
})(localforage.clear);

const _message = e => {
  const url = new URL(e.origin);
  if (url && /^127\.0\.0\.1(?::|$)|app\.webaverse\.com/.test(url.host)) {
    const j = e.data;
    if (j && j._localstorage && j.port) {
      const {port} = j;
      port.onmessage = async e => {
        // console.log('localstorage request', e.data);
        const j = e.data;
        const {method, id} = j;
        switch (method) {
          case 'get': {
            const {key} = j;
            const s = await localforage.getItem(key);
            const result = typeof s === 'string' ? JSON.parse(s) : null;
            // console.log('localstorage response', e.data, result);
            port.postMessage({
              id,
              result,
            });
            break;
          }
          case 'set': {
            const {key, value} = j;
            await localforage.setItem(key, JSON.stringify(value));
            const result = null;
            // console.log('localstorage response', e.data, result);
            port.postMessage({
              id,
              result,
            });
            break;
          }
          case 'remove': {
            const {key} = j;
            const s = await localforage.removeItem(key);
            const result = null;
            // console.log('localstorage response', e.data, result);
            port.postMessage({
              id,
              result,
            });
            break;
          }
        }
      };
    }
  }
};
window.addEventListener('message', _message);

const clearButton = document.getElementById('clear-button');
clearButton.addEventListener('click', e => {
  localforage.clear();
});
</script>
</body>
</html>